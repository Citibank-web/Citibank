<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Citibank</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; display:flex; }

  /* Sidebar */
  .sidebar {
    width:160px; background:#003366; color:white; height:100vh; padding-top:20px;
    box-shadow:2px 0 10px rgba(0,0,0,.1); position:fixed; top:0; left:0;
  }
  .sidebar a {
    display:block; padding:12px; color:white; text-decoration:none; font-weight:500;
  }
  .sidebar a:hover { background:#0055a5; }

  /* Content */
  .content { margin-left:160px; padding:20px; flex:1; }

  /* Admin login form */
  #adminLogin { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; width:100%; }
  #adminLogin input { padding:10px; margin:10px 0; width:250px; border-radius:5px; border:1px solid #ccc; }
  #adminLogin button { padding:10px 20px; background:#003366; color:white; border:none; border-radius:5px; cursor:pointer; }
  #adminLogin button:hover { background:#0055a5; }

  /* Card style */
  .card { background:white; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 8px 20px rgba(0,0,0,0.05); }
  .card h2 { margin-top:0; color:#003366; }

  /* Form inside card */
  .card input { padding:10px; margin:5px 0; width:100%; border-radius:5px; border:1px solid #ccc; }
  .card button { margin-top:10px; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; color:white; font-weight:600; }
  .btn-add { background:linear-gradient(45deg,#0066cc,#3399ff); }
  .btn-save { background:green; }
  .btn-delete { background:#cc3300; }

  /* Table */
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { padding:12px; border:1px solid #ccc; text-align:left; }
  th { background:#003366; color:white; }

  @media(max-width:768px){
    .sidebar { width:140px; }
    .content { margin-left:140px; }
  }
</style>
</head>
<body>

<div id="adminLogin">
  <h2>Admin Login</h2>
  <input type="password" id="adminPass" placeholder="Enter Admin Password">
  <button onclick="checkAdminPass()">Login</button>
</div>

<div id="adminContent" style="display:none;">
  <div class="sidebar">
    <a href="Dashboard.html">Dashboard</a>
    <a href="kyc.html">KYC</a>
    <a href="history.html">Transaction History</a>
    <a href="#" id="logoutLink">Logout</a>
  </div>

  <div class="content">
    <div class="card">
      <h2>Add New User</h2>
      <input type="text" id="newFullName" placeholder="Full Name">
      <input type="text" id="newEmail" placeholder="Email">
      <input type="text" id="newAcct" placeholder="Account Number">
      <input type="number" id="newBalance" placeholder="Balance">
      <input type="text" id="newPhoto" placeholder="Profile Photo URL">
      <button class="btn-add" onclick="addUser()">Add User</button>
    </div>

    <div class="card">
      <h2>User List</h2>
      <table id="userTable">
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Account No</th>
            <th>Balance</th>
            <th>Photo</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from './supabase.js';

const ADMIN_PASSWORD = "Admin1234!";

async function checkAdminPass() {
  const entered = document.getElementById("adminPass").value;
  if(entered === ADMIN_PASSWORD) {
    document.getElementById("adminLogin").style.display = "none";
    document.getElementById("adminContent").style.display = "flex";
    await loadUsers();
  } else {
    alert("Incorrect password! Access denied.");
  }
}

// Load users
async function loadUsers() {
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if(authError || !user) location.href = "index.html";

  const { data, error } = await supabase.from('users').select('*');
  if(error) { console.error(error); return; }

  const tbody = document.querySelector("#userTable tbody");
  tbody.innerHTML = "";

  data.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td contenteditable="true">${u.full_name}</td>
      <td>${u.email}</td>
      <td contenteditable="true">${u.account_number}</td>
      <td contenteditable="true">${u.balance}</td>
      <td contenteditable="true">${u.photo}</td>
      <td>
        <button class="btn-save" onclick="updateUser('${u.id}', this)">Save</button>
        <button class="btn-delete" onclick="deleteUser('${u.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Add user
async function addUser() {
  const fullName = document.getElementById("newFullName").value;
  const email = document.getElementById("newEmail").value;
  const acct = document.getElementById("newAcct").value;
  const balance = parseFloat(document.getElementById("newBalance").value) || 0;
  const photo = document.getElementById("newPhoto").value;

  const { data: authUser, error: authError } = await supabase.auth.admin.createUser({
    email, password: "DefaultPass123"
  });
  if(authError) { alert(authError.message); return; }

  const { data, error } = await supabase.from('users').insert([{
    id: authUser.user.id,
    full_name: fullName,
    email,
    account_number: acct,
    balance,
    photo
  }]);
  if(error) { alert(error.message); return; }
  alert("User added successfully!");
  loadUsers();
}

// Update user
async function updateUser(id, btn) {
  const tr = btn.parentElement.parentElement;
  const [full_name, , account_number, balance, photo] = [...tr.children].map(td => td.innerText);
  const { data, error } = await supabase.from('users')
    .update({ full_name, account_number, balance: parseFloat(balance), photo })
    .eq('id', id);
  if(error) { alert(error.message); return; }
  alert("User updated!");
}

// Delete user
async function deleteUser(id) {
  if(!confirm("Are you sure to delete this user?")) return;
  const { data, error } = await supabase.from('users').delete().eq('id', id);
  if(error) { alert(error.message); return; }
  alert("User deleted!");
  loadUsers();
}

// Logout
document.getElementById("logoutLink").addEventListener("click", async () => {
  await supabase.auth.signOut();
  location.href="index.html";
});
</script>
</body>
</html>
